{% extends "modelo.html" %}
{% block conteudo %}
<link rel="stylesheet" href="../static/styles/carrinho.css">

<body>
    <main>

        {% for registro in lista_carrinho.produtos %}
        <form action="/excluir_produto_carrinho" class="form-exclui-carrinho" method="post">

            <section class="container-principal">

                <div class="produto-card">

                    <div class="imgdiv">
                        <img class="img-produto" src="{{ registro.imagem_produto }}" alt="Imagem Produto">

                        <button value="{{ registro.id_carrinho }}" name="btn-excluir" class="button" value="{{ registro.id_produto }}">
                            <img src="../static/img/lixo.png" alt="Excluir Produto">
                        </button>

                        <div class="direita-card">
                            <div class="cima">
                                <span>{{ registro.nome_produto }}</span>

                                <div class="qnt-btn">
                                    <button class="menos-btn" type="button" data-id="{{ registro.id_carrinho }}">-</button>
                                    <input type="number" id="quantidade-{{ registro.id_carrinho }}" value="{{ registro.quantidade }}" data-id="{{ registro.id_carrinho }}" min="1">
                                    <button class="mais-btn" type="button" data-id="{{ registro.id_carrinho }}">+</button>
                                </div>

                            </div>

                            <div class="baixo">
                                <span class="desc-baixo">Marmita de 500g acompanha Arroz, feijão, Batata frit...</span>
                                <span class="preco-item">R$ {{ registro.preco }}</span>

                                <span class="obs-item">OBS: Sem feijão, pfv</span>
                            </div>

                        </div>
                    </div>
                </div>
            </section>
        </form>
        {% endfor %}

        <div class="finalizacao">
            <div class="preco">
                <span class="span1">Total:</span>
                <span id="total-preco" class="span2">R$ {{ lista_carrinho.total_preco }}</span>
            </div>

            <form action="/enviar_carrinho" method="post">
                <button name="id_carrinho" class="button1">Enviar</button>
            </form>
            <a href="/" class="button1">Continuar Comprando</a>
        </div>

        <span class="span3">.</span>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Função para aumentar a quantidade de produtos
            document.querySelectorAll('.mais-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const idCarrinho = this.getAttribute('data-id');
                    const quantidadeInput = document.getElementById(`quantidade-${idCarrinho}`);
                    let quantidade = parseInt(quantidadeInput.value, 10);
                    quantidade++;
                    quantidadeInput.value = quantidade;
                    atualizarQuantidade(idCarrinho, quantidade);
                });
            });

            // Função para diminuir a quantidade de produtos
            document.querySelectorAll('.menos-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const idCarrinho = this.getAttribute('data-id');
                    const quantidadeInput = document.getElementById(`quantidade-${idCarrinho}`);
                    let quantidade = parseInt(quantidadeInput.value, 10);
                    if (quantidade > 1) {
                        quantidade--;
                        quantidadeInput.value = quantidade;
                        atualizarQuantidade(idCarrinho, quantidade);
                    } else {
                        alert("Número mínimo de pedido é 1");
                    }
                });
            });

            // Função AJAX para atualizar a quantidade de produtos no backend
            function atualizarQuantidade(idCarrinho, quantidade) {
                fetch('/atualizar_quantidade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_carrinho: idCarrinho, quantidade: quantidade })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        atualizarPrecoTotal(); // Atualiza o preço total
                    } else {
                        alert('Erro ao atualizar quantidade');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
            }

            // Função AJAX para excluir produtos do carrinho
            document.querySelectorAll('.btn-excluir').forEach(button => {
                button.addEventListener('click', function () {
                    const idCarrinho = this.getAttribute('data-id');
                    excluirProduto(idCarrinho);
                });
            });

            // Função AJAX para excluir produto do carrinho
            function excluirProduto(idCarrinho) {
                fetch('/excluir_produto_carrinho', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_carrinho: idCarrinho })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Atualiza a página após exclusão bem-sucedida
                    } else {
                        alert('Erro ao excluir produto');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
            }

            // Função AJAX para atualizar o preço total do carrinho
            function atualizarPrecoTotal() {
                fetch('/atualizar_preco_total', {
                    method: 'GET'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('total-preco').innerText = `R$ ${data.total_preco}`;
                    } else {
                        alert('Erro ao atualizar o preço total');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
            }
        });
    </script>
</body>
{% endblock %}
    